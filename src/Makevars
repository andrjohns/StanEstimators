PKG_CPPFLAGS = -I"../inst/include" -I"sundials/sundials" -D_REENTRANT
PKG_CPPFLAGS += -include "../inst/include/stan_sundials_printf_override.hpp"
PKG_CPPFLAGS += -DSTRICT_R_HEADERS -D_HAS_AUTO_PTR_ETC=0 -DEIGEN_PERMANENTLY_DISABLE_STUPID_WARNINGS
PKG_CXXFLAGS += $(shell "${R_HOME}/bin/Rscript" -e "RcppParallel::CxxFlags()" | tail -n 1)
PKG_LIBS = $(shell "${R_HOME}/bin/Rscript" -e "RcppParallel::RcppParallelLibs()" | tail -n 1)
PKG_LIBS += ../inst/lib/$(R_ARCH)/libStanEstimators.a

SUNDIALS_SOURCES := \
  $(wildcard sundials/cvodes/*.c) \
  $(wildcard sundials/idas/*.c) \
  $(wildcard sundials/kinsol/*.c) \
  $(filter-out sundials/sundials/sundials_profiler.c, $(wildcard sundials/sundials/*.c)) \
  $(wildcard sundials/sunmatrix/band/[^f]*.c) \
  $(wildcard sundials/sunmatrix/dense/[^f]*.c) \
  $(wildcard sundials/sunlinsol/band/[^f]*.c) \
  $(wildcard sundials/sunlinsol/dense/[^f]*.c) \
  $(wildcard sundials/sunnonlinsol/newton/[^f]*.c) \
  $(wildcard sundials/sunnonlinsol/fixedpoint/[^f]*.c) \
  sundials/nvector/serial/nvector_serial.c sundials/sundials/sundials_math.c

SUNDIALS_OBJECTS := $(SUNDIALS_SOURCES:.c=.o)

STATIC_OBJECTS = $(SUNDIALS_OBJECTS) call_stan.o model_methods.o

$(SHLIB): build-static

build-static: $(STATIC_OBJECTS)
	@mkdir -p ../inst/lib/$(R_ARCH)
	$(AR) -rs ../inst/lib/$(R_ARCH)/libStanEstimators.a $(STATIC_OBJECTS)
